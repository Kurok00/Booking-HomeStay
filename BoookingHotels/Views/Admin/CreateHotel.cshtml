@model BoookingHotels.Models.Hotel
@{
    ViewData["Title"] = "Thêm Khách Sạn Mới";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white py-3">
                    <h3 class="mb-0">
                        <i class="bi bi-building-add me-2"></i> Thêm Khách Sạn Mới
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form asp-action="CreateHotel" method="post" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger rounded-3" role="alert"></div>

                        <!-- Thông tin cơ bản -->
                        <div class="section-header mb-3">
                            <h5 class="text-primary">
                                <i class="bi bi-info-circle"></i> Thông tin cơ bản
                            </h5>
                            <hr />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Name" class="form-label fw-bold">
                                <i class="bi bi-building text-primary"></i> Tên khách sạn 
                                <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg" 
                                   placeholder="VD: InterContinental Danang Sun Peninsula Resort" required />
                            <span asp-validation-for="Name" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label fw-bold">
                                <i class="bi bi-card-text text-info"></i> Mô tả
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="Nhập mô tả chi tiết về khách sạn..."></textarea>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Mô tả chi tiết sẽ giúp thu hút khách hàng
                            </small>
                        </div>

                        <!-- Địa chỉ -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary">
                                <i class="bi bi-geo-alt"></i> Địa chỉ & Vị trí
                            </h5>
                            <hr />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Address" class="form-label fw-bold">
                                <i class="bi bi-signpost text-success"></i> Địa chỉ 
                                <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Address" class="form-control" 
                                   placeholder="VD: Số 123, Đường ABC" required />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="City" class="form-label fw-bold">
                                    <i class="bi bi-pin-map text-warning"></i> Thành phố
                                </label>
                                <input asp-for="City" class="form-control" 
                                       placeholder="VD: Đà Nẵng" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Country" class="form-label fw-bold">
                                    <i class="bi bi-flag text-danger"></i> Quốc gia
                                </label>
                                <input asp-for="Country" class="form-control" 
                                       placeholder="VD: Việt Nam" value="Việt Nam" />
                            </div>
                        </div>

                        <div class="card border-info mb-3">
                            <div class="card-body">
                                <h6 class="fw-bold text-info mb-3">
                                    <i class="bi bi-search"></i> Tìm kiếm địa điểm
                                </h6>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="searchAddress" 
                                           placeholder="Nhập địa chỉ để tìm kiếm (VD: InterContinental Danang Sun Peninsula Resort)" />
                                    <button class="btn btn-primary" type="button" onclick="searchLocation()">
                                        <i class="bi bi-search"></i> Tìm
                                    </button>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Hoặc click trực tiếp vào bản đồ bên phải
                                </small>
                            </div>
                        </div>

                        <div class="alert alert-success mb-3" role="alert">
                            <h6 class="alert-heading fw-bold">
                                <i class="bi bi-google"></i> Cách lấy tọa độ từ Google Maps:
                            </h6>
                            <ol class="mb-0 small">
                                <li>Mở <a href="https://www.google.com/maps" target="_blank" class="alert-link">Google Maps</a></li>
                                <li>Tìm và click chuột phải vào vị trí khách sạn</li>
                                <li>Chọn tọa độ đầu tiên (VD: 16.047079, 108.206230)</li>
                                <li>Dán vào ô "Tìm kiếm địa điểm" ở trên hoặc nhập trực tiếp bên dưới</li>
                            </ol>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Latitude" class="form-label fw-bold">
                                    <i class="bi bi-compass"></i> Vĩ độ (Latitude)
                                </label>
                                <input asp-for="Latitude" class="form-control" id="latitude" 
                                       placeholder="VD: 16.047079" step="any" type="number" 
                                       onchange="updateMapFromInputs()" />
                                <small class="text-muted">Có thể nhập thủ công từ Google Maps</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Longitude" class="form-label fw-bold">
                                    <i class="bi bi-compass"></i> Kinh độ (Longitude)
                                </label>
                                <input asp-for="Longitude" class="form-control" id="longitude" 
                                       placeholder="VD: 108.206230" step="any" type="number"
                                       onchange="updateMapFromInputs()" />
                                <small class="text-muted">Có thể nhập thủ công từ Google Maps</small>
                            </div>
                        </div>

                        <!-- Hình ảnh -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary">
                                <i class="bi bi-images"></i> Hình ảnh
                            </h5>
                            <hr />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-camera text-secondary"></i> Ảnh khách sạn
                            </label>
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <input type="file" name="images" class="form-control" multiple accept="image/*" id="imageInput" />
                                    <small class="form-text text-muted mt-2 d-block">
                                        <i class="bi bi-info-circle"></i> Chọn nhiều ảnh (JPG, PNG) để showcase khách sạn
                                    </small>
                                    <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin khác -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary">
                                <i class="bi bi-sliders"></i> Cài đặt khác
                            </h5>
                            <hr />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-event"></i> Ngày tạo
                            </label>
                            <input asp-for="CreatedAt" type="datetime-local" class="form-control"
                                   value="@(Model.CreatedAt.HasValue? Model.CreatedAt.Value.ToString("yyyy-MM-ddTHH:mm") : DateTime.Now.ToString("yyyy-MM-ddTHH:mm"))" />
                            <small class="text-muted">Mặc định là thời điểm hiện tại</small>
                        </div>

                        <div class="card border-success mb-4" style="display:none">
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input asp-for="Status" class="form-check-input" checked 
                                           style="width: 3em; height: 1.5em;" />
                                    <label asp-for="Status" class="form-check-label ms-2 fw-bold">
                                        <i class="bi bi-toggle-on text-success"></i> Kích hoạt ngay
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between gap-2 mt-4">
                            <a asp-action="Hotels" class="btn btn-secondary btn-lg px-4">
                                <i class="bi bi-arrow-left"></i> Quay lại
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-4">
                                <i class="bi bi-check-circle"></i> Lưu khách sạn
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Map Column -->
        <div class="col-lg-4">
            <div class="card shadow-lg border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-map"></i> Chọn vị trí trên bản đồ
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-cursor-fill"></i> Click để chọn vị trí
                        </small>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="getCurrentLocation()">
                            <i class="bi bi-crosshair"></i> Vị trí hiện tại
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .section-header h5 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .section-header hr {
        border-top: 2px solid #e0e7ff;
        margin-top: 0.5rem;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .card {
        border-radius: 1rem;
    }

    .form-control-lg {
        border-radius: 0.5rem;
    }

    #imagePreview img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 2px solid #dee2e6;
    }

    .leaflet-container {
        border-radius: 0 0 1rem 1rem;
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Initialize map
    var map = L.map('map').setView([16.047079, 108.206230], 13); // Đà Nẵng

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    var marker;

    // Add marker to map
    function addMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
        } else {
            marker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }),
                draggable: true
            }).addTo(map);
            
            // Allow dragging marker
            marker.on('dragend', function(e) {
                var position = marker.getLatLng();
                updateCoordinates(position.lat, position.lng);
            });
        }
        
        marker.bindPopup("<b>Vị trí khách sạn</b><br>Lat: " + lat.toFixed(6) + "<br>Lng: " + lng.toFixed(6)).openPopup();
        updateCoordinates(lat, lng);
    }

    // Update coordinate inputs
    function updateCoordinates(lat, lng) {
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lng.toFixed(6);
    }

    // Click on map to set location
    map.on('click', function (e) {
        addMarker(e.latlng.lat, e.latlng.lng);
    });

    // Search location by address
    function searchLocation() {
        var searchText = document.getElementById('searchAddress').value.trim();
        
        if (!searchText) {
            alert('Vui lòng nhập địa chỉ để tìm kiếm');
            return;
        }

        // Check if input is coordinates (e.g., "16.047079, 108.206230")
        var coordPattern = /^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/;
        var match = searchText.match(coordPattern);
        
        if (match) {
            var lat = parseFloat(match[1]);
            var lng = parseFloat(match[2]);
            
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                addMarker(lat, lng);
                map.setView([lat, lng], 15);
                return;
            }
        }

        // Search using Nominatim (OpenStreetMap)
        var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchText)}&countrycodes=vn&limit=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lng = parseFloat(data[0].lon);
                    addMarker(lat, lng);
                    map.setView([lat, lng], 15);
                } else {
                    alert('Không tìm thấy địa chỉ. Vui lòng thử:\n1. Nhập chính xác hơn\n2. Dán tọa độ từ Google Maps (VD: 16.047079, 108.206230)\n3. Click trực tiếp vào bản đồ');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                alert('Lỗi khi tìm kiếm. Vui lòng thử click trực tiếp vào bản đồ hoặc nhập tọa độ từ Google Maps');
            });
    }

    // Allow Enter key in search box
    document.getElementById('searchAddress').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocation();
        }
    });

    // Update map when coordinates are manually entered
    function updateMapFromInputs() {
        var lat = parseFloat(document.getElementById("latitude").value);
        var lng = parseFloat(document.getElementById("longitude").value);
        
        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
            addMarker(lat, lng);
            map.setView([lat, lng], 15);
        }
    }

    // Get current location using browser geolocation
    function getCurrentLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    addMarker(lat, lng);
                    map.setView([lat, lng], 15);
                },
                function(error) {
                    alert('Không thể lấy vị trí hiện tại: ' + error.message);
                }
            );
        } else {
            alert('Trình duyệt không hỗ trợ định vị GPS');
        }
    }

    // Image preview
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        
        const files = Array.from(e.target.files);
        
        if (files.length > 0) {
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'position-relative';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}">
                            <span class="badge bg-primary position-absolute top-0 start-0 m-2">
                                ${index + 1}
                            </span>
                        `;
                        preview.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}